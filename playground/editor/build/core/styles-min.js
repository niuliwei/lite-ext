KISSY.Editor.add("styles",function(o){function N(a,e){for(var b in a)a[b]=a[b].replace(X,function(c,d){return e[d]})}function A(a,e){if(e){a=B.clone(a);N(a.attributes,e);N(a.styles,e)}var b=this.element=this.element=(a.element||"*").toLowerCase();this.type=this.type=b=="#"||Y[b]?s.STYLE_BLOCK:O[b]?s.STYLE_OBJECT:s.STYLE_INLINE;this._={definition:a}}function P(a,e){var b=e?this.removeFromRange:this.applyToRange;a.body.focus();for(var c=new Z(a),d=c.getRanges(),g=0;g<d.length;g++)b.call(this,d[g]);
c.selectRanges(d)}function I(a,e){var b;b=a.element;if(b=="*")b="span";b=new w(e.createElement(b));return Q(b,a)}function Q(a,e){var b=e._.definition,c=b.attributes;b=A.getStyleText(b);if(c)for(var d in c)a.attr(d,c[d]);if(b)a[0].style.cssText=b;return a}function $(a){var e=a.createBookmark(j),b=a.createIterator();b.enforceRealBlocks=j;b.enlargeBr=j;for(var c,d=a.document;c=b.getNextParagraph();){var g=I(this,d);c=c;var f=g;g=f._4e_name=="pre";var h=c._4e_name=="pre",m=!g&&h;if(g&&!h){h=c;f=f;m=h.html();
m=C(m,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,"");m=m.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1");m=m.replace(/([ \t\n\r]+|&nbsp;)/g," ");m=m.replace(/<br\b[^>]*>/gi,"\n");if(J.ie){h=h[0].ownerDocument.createElement("div");h.appendChild(f[0]);f[0].outerHTML="<pre>"+m+"</pre>";f=new w(h.firstChild);f._4e_remove()}else f.html(m);f=f}else if(m)f=aa(ba(c),f);else c._4e_moveChildren(f);c[0].parentNode.replaceChild(f[0],c[0]);if(g){c=f;g=void 0;if((g=c._4e_previousSourceNode(j,x.NODE_ELEMENT))&&g._4e_name()==
"pre"){f=C(g.html(),/\n$/,"")+"\n\n"+C(c.html(),/^\n/,"");if(J.ie)c[0].outerHTML="<pre>"+f+"</pre>";else c.html(f);g._4e_remove()}}}a.moveToBookmark(e)}function C(a,e,b){var c="",d="";a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(g,f,h){f&&(c=f);h&&(d=h);return""});return c+a.replace(e,b)+d}function ba(a){var e=[];C(a._4e_outerHtml(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(b,c){e.push(c)});return e}function aa(a,e){for(var b=e[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var d=a[c];d=d.replace(/(\r\n|\r)/g,"\n");d=C(d,/^[ \t]*\n/,"");d=C(d,/\n$/,"");d=C(d,/^[ \t]+|[ \t]+$/g,function(f,h){return f.length==1?"&nbsp;":h?" "+Array(f.length).join("&nbsp;"):Array(f.length).join("&nbsp;")+" "});d=d.replace(/\n/g,"<br>");d=d.replace(/[ \t]{2,}/g,function(f){return Array(f.length).join("&nbsp;")+" "});var g=e._4e_clone();g.html(d);b.appendChild(g[0])}return b}
function ca(a){var e=a.document;if(a.collapsed){e=I(this,e);a.insertNode(e);a.moveToPosition(e,F.POSITION_BEFORE_END)}else{var b=this.element,c=this._.definition,d,g=o.XHTML_DTD[b]||(d=j,o.XHTML_DTD.span),f=a.createBookmark();a.enlarge(F.ENLARGE_ELEMENT);a.trim();var h=a.createBookmark(),m=h.startNode;h=h.endNode;for(var k=m,q;k&&k[0];){var i=v;if(D._4e_equals(k,h)){k=u;i=j}else{var l=k[0].nodeType,p=l==x.NODE_ELEMENT?k._4e_name():u;if(p&&k.attr("_ke_bookmark")){k=k._4e_nextSourceNode(j);continue}if(!p||
g[p]&&(k._4e_position(h)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(k))){var y=k.parent();if(y&&y[0]&&((o.XHTML_DTD[y._4e_name()]||o.XHTML_DTD.span)[b]||d)&&(!c.parentRule||c.parentRule(y))){if(!q&&(!p||!o.XHTML_DTD.$removeEmpty[p]||(k._4e_position(h)|n.POSITION_PRECEDING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_PRECEDING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED)){q=
new da(e);q.setStartBefore(k)}if(l==x.NODE_TEXT||l==x.NODE_ELEMENT&&!k[0].childNodes.length){l=k;var t;for(p=l._4e_next(function(ea){return!ea.attr("_ke_bookmark")});!p&&(t=l.parent(),g[t._4e_name()])&&(t._4e_position(m)|n.POSITION_FOLLOWING|n.POSITION_IDENTICAL|n.POSITION_IS_CONTAINED)==n.POSITION_FOLLOWING+n.POSITION_IDENTICAL+n.POSITION_IS_CONTAINED&&(!c.childRule||c.childRule(t));)l=t;q.setEndAfter(l);l[0].nextSibling||(i=j)}}else i=j}else i=j;k=k._4e_nextSourceNode()}if(i&&q&&!q.collapsed){i=
I(this,e);l=q.getCommonAncestor();p={styles:{},attrs:{},blockedStyles:{},blockedAttrs:{}};for(var r,E,H;i&&l&&i[0]&&l[0];){if(l._4e_name()==b){for(r in c.attributes)if(!(p.blockedAttrs[r]||!(H=l.attr(E))))if(i.attr(r)==H)i.removeAttr(r);else p.blockedAttrs[r]=1;for(E in c.styles)if(!(p.blockedStyles[E]||!(H=l._4e_style(E))))if(i._4e_style(E)==H)i._4e_style(E,"");else p.blockedStyles[E]=1;if(!i._4e_hasAttributes()){i=u;break}}l=l.parent()}if(i){i[0].appendChild(q.extractContents());R(this,i);q.insertNode(i);
i._4e_mergeSiblings();J.ie||i[0].normalize()}else{i=new w(e.createElement("span"));i[0].appendChild(q.extractContents());q.insertNode(i);R(this,i);i._4e_remove(true)}q=u}}m._4e_remove();h._4e_remove();a.moveToBookmark(f);a.shrink(F.SHRINK_TEXT)}}function fa(a){a.enlarge(F.ENLARGE_ELEMENT);var e=a.createBookmark(),b=e.startNode;if(a.collapsed){for(var c=new K(b.parent()),d,g=0,f;g<c.elements.length&&(f=c.elements[g]);g++){if(f==c.block||f==c.blockLimit)break;if(this.checkElementRemovable(f)){var h=
a.checkBoundaryOfElement(f,F.END),m=!h&&a.checkBoundaryOfElement(f,F.START);if(m||h){d=f;d.match=m?"start":"end"}else{f._4e_mergeSiblings();f._4e_name()==this.element?L(this,f):M(f,G(this)[f._4e_name()])}}}if(d&&d[0]){f=b;for(g=0;;g++){h=c.elements[g];if(D._4e_equals(h,d))break;else if(h.match)continue;else h=h._4e_clone();h[0].appendChild(f[0]);f=h}D[d.match=="start"?"insertBefore":"insertAfter"](f,d)}}else{var k=e.endNode,q=this;c=function(){for(var i=new K(b.parent()),l=new K(k.parent()),p=u,y=
u,t=0;t<i.elements.length;t++){var r=i.elements[t];if(r==i.block||r==i.blockLimit)break;if(q.checkElementRemovable(r))p=r}for(t=0;t<l.elements.length;t++){r=l.elements[t];if(r==l.block||r==l.blockLimit)break;if(q.checkElementRemovable(r))y=r}y&&k._4e_breakParent(y);p&&b._4e_breakParent(p)};c();for(d=new w(b[0].nextSibling);d[0]!==k[0];){g=d._4e_nextSourceNode();if(d[0]&&d[0].nodeType==x.NODE_ELEMENT&&this.checkElementRemovable(d)){d._4e_name()==this.element?L(this,d):M(d,G(this)[d._4e_name()]);if(g[0].nodeType==
x.NODE_ELEMENT&&g.contains(b)){c();g=new w(b[0].nextSibling)}}d=g}}a.moveToBookmark(e)}function S(a){var e={};a.replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,d){e[c]=d});return e}function T(a,e){var b;if(e!==v){b=document.createElement("span");b.style.cssText=a;b=b.style.cssText||""}else b=a;return b.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function G(a){if(a._.overrides)return a._.overrides;var e=a._.overrides=
{},b=a._.definition.overrides;if(b){B.isArray(b)||(b=[b]);for(var c=0;c<b.length;c++){var d=b[c],g,f;if(typeof d=="string")g=d.toLowerCase();else{g=d.element?d.element.toLowerCase():a.element;f=d.attributes}d=e[g]||(e[g]={});if(f){d=d.attributes=d.attributes||[];for(var h in f)d.push([h.toLowerCase(),f[h]])}}}return e}function L(a,e){var b=a._.definition,c=ga.mix(b.attributes,G(a)[e._4e_name()]);b=b.styles;var d=B.isEmptyObject(c)&&B.isEmptyObject(b),g;for(g in c)if(!((g=="class"||a._.definition.fullMatch)&&
e.attr(g)!=U(g,c[g]))){d=d||!!e._4e_hasAttribute(g);e.removeAttr(g)}for(var f in b)if(!(a._.definition.fullMatch&&e._4e_style(f)!=U(f,b[f],j))){d=d||!!e._4e_style(f);e._4e_style(f,"")}V(e)}function U(a,e,b){var c=new w("<span>");c[b?"_4e_style":"attr"](a,e);return c[b?"_4e_style":"attr"](a)}function R(a,e){for(var b=G(a),c=e.all(a.element),d=c.length;--d>=0;)L(a,new w(c[d]));for(var g in b)if(g!=a.element){c=e.all(g);for(d=c.length-1;d>=0;d--){var f=new w(c[d]);M(f,b[g])}}}function M(a,e){var b=e&&
e.attributes;if(b)for(var c=0;c<b.length;c++){var d=b[c][0],g;if(g=a.attr(d)){var f=b[c][1];if(f===u||f.test&&f.test(g)||typeof f=="string"&&g==f)a[0].removeAttribute(d)}}V(a)}function V(a){if(!a._4e_hasAttributes()){var e=a[0].firstChild,b=a[0].lastChild;a._4e_remove(j);if(e){e.nodeType==x.NODE_ELEMENT&&D._4e_mergeSiblings(e);b&&e!=b&&b.nodeType==x.NODE_ELEMENT&&D._4e_mergeSiblings(b)}}}var j=true,v=false,u=null,B=KISSY,ga=o.Utils,D=B.DOM,s={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},F=o.RANGE,
Z=o.Selection,x=o.NODE,n=o.POSITION,da=o.Range,w=B.Node,J=B.UA,K=o.ElementPath,Y={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},O={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},W=/\s*(?:;\s*|$)/g,X=/#\((.+?)\)/g;o.STYLE=s;A.prototype={apply:function(a){P.call(this,a,v)},remove:function(a){P.call(this,a,j)},applyToRange:function(a){return(this.applyToRange=this.type==s.STYLE_INLINE?ca:this.type==s.STYLE_BLOCK?$:this.type==s.STYLE_OBJECT?u:u).call(this,
a)},removeFromRange:function(a){return(this.removeFromRange=this.type==s.STYLE_INLINE?fa:u).call(this,a)},applyToObject:function(a){Q(a,this)},checkElementRemovable:function(a,e){if(!a)return v;var b=this._.definition;if(a._4e_name()==this.element){if(!e&&!a._4e_hasAttributes())return j;var c=b._AC;if(c)b=c;else{c={};var d=0,g=b.attributes;if(g)for(var f in g){d++;c[f]=g[f]}if(g=A.getStyleText(b)){c.style||d++;c.style=g}c._length=d;b=b._AC=c}if(b._length){for(var h in b)if(h!="_length"){d=a.attr(h)||
"";if(h=="style")a:{c=b[h];d=T(d,v);typeof c=="string"&&(c=S(c));typeof d=="string"&&(d=S(d));g=void 0;for(g in c)if(!(g in d&&(d[g]==c[g]||c[g]=="inherit"||d[g]=="inherit"))){c=v;break a}c=j}else c=b[h]==d;if(c){if(!e)return j}else if(e)return v}if(e)return j}else return j}if(h=G(this)[a._4e_name()]){if(!(b=h.attributes))return j;for(c=0;c<b.length;c++){h=b[c][0];if(h=a.attr(h)){d=b[c][1];if(d===u||typeof d=="string"&&h==d||d.test&&d.test(h))return j}}}return v},checkActive:function(a){switch(this.type){case s.STYLE_BLOCK:return this.checkElementRemovable(a.block||
a.blockLimit,j);case s.STYLE_OBJECT:case s.STYLE_INLINE:for(var e=a.elements,b=0,c;b<e.length;b++){c=e[b];if(!(this.type==s.STYLE_INLINE&&(D._4e_equals(c,a.block)||D._4e_equals(c,a.blockLimit))))if(!(this.type==s.STYLE_OBJECT&&!(c._4e_name()in O)))if(this.checkElementRemovable(c,j))return j}}return v}};A.getStyleText=function(a){var e=a._ST;if(e)return e;e=a.styles;var b=a.attributes&&a.attributes.style||"",c="";if(b.length)b=b.replace(W,";");for(var d in e){var g=e[d],f=(d+":"+g).replace(W,";");
if(g=="inherit")c+=f;else b+=f}if(b.length)b=T(b);b+=c;return a._ST=b};o.Style=A;o.Style=A;var z=A.prototype;o.Utils.extern(z,{apply:z.apply,remove:z.remove,applyToRange:z.applyToRange,removeFromRange:z.removeFromRange,applyToObject:z.applyToObject,checkElementRemovable:z.checkElementRemovable,checkActive:z.checkActive})});
