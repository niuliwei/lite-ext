KISSY.Editor.add("contextmenu",function(){function g(a){this.cfg=a;i.Utils.lazyRun(this,"_prepareShow","_realShow")}function q(a,c){for(var b=0;b<c.length;b++){var d=c[b];if(j.isFunction(d)){if(d(new l(a)))return true}else if(r.test(a,d))return true}return false}var i=KISSY.Editor,j=KISSY,l=j.Node,r=j.DOM,o=j.Event;if(i.ContextMenu)j.log("attach ContextMenu twice","warn");else{g.ATTRS={editor:{}};var h=[];g.register=function(a){var c=new g(a),b=a.editor.document;h.push({doc:b,rules:a.rules||[],instance:c});
if(!b.ke_contextmenu){b.ke_contextmenu=1;o.on(b,"mousedown",g.hide);o.on(b,"contextmenu",function(d){g.hide.call(this);for(var f=new l(d.target);f;){var k=false;if(f._4e_name()=="body")break;for(var e=0;e<h.length;e++){var m=h[e].instance,s=h[e].rules;if(b===h[e].doc&&q(f[0],s)){d.preventDefault();k=true;var n=d.pageX,p=d.pageY;if(!n){e=f._4e_getOffset();n=e.left;p=e.top}setTimeout(function(){m.show(i.Utils.getXY(n,p,b,document))},30);break}}if(k)break;f=f.parent()}})}return c};g.hide=function(){for(var a=
0;a<h.length;a++){var c=h[a].instance;this===h[a].doc&&c.hide()}};var t=i.Overlay;j.augment(g,{_init:function(){var a=this,c=a.cfg,b=c.funcs;a.el=new t({content:"<div>",autoRender:true,width:c.width,elCls:"ke-menu"});a.elDom=a.el.get("contentEl").one("div");c=a.elDom;for(var d in b){var f=new l("<a href='#'>"+d+"</a>");c[0].appendChild(f[0]);(function(k,e){k._4e_unselectable();k.on("click",function(m){a.hide();m.halt();setTimeout(e,30)})})(f,b[d])}},destroy:function(){if(this.el){this.elDom.children().detach();
this.el.destroy()}},hide:function(){this.el&&this.el.hide()},_realShow:function(a){i.fire("contextmenu",{contextmenu:this});this.el.set("xy",[a.left,a.top]);this.el.show()},_prepareShow:function(){this._init()},show:function(a){this._prepareShow(a)}});i.ContextMenu=g}},{attach:false,requires:["overlay"]});
