KISSY.Editor.add("dragupload",function(p){function q(a){a=a.originalEvent.target;if(d.DOM._4e_name(a)=="img"&&a.src.match(/^file:\/\//))m[a.src]=a}function s(a,g){var e=new FileReader;e.onload=function(f){var h=a.name;f=f.target.result;var b=new XMLHttpRequest;b.open("POST",t,true);b.onreadystatechange=function(){if(b.readyState==4){if(b.status==200||b.status==304){if(b.responseText!=""){var u=d.JSON.parse(b.responseText);g[0].src=u.imgUrl}}else{alert("\u670d\u52a1\u5668\u7aef\u51fa\u9519\uff01");g._4e_remove();d.log(b)}b.onreadystatechange=
null}};var c="\r\n------kissy-editor-2.1\r\n";c+='Content-Disposition: form-data; name="'+v+'"; filename="'+encodeURIComponent(h)+'"\r\n';c+="Content-Type: "+(a.type||"application/octet-stream")+"\r\n\r\n";c+=f+"\r\n";j=r.Utils.normParams(j);for(var n in j)if(j.hasOwnProperty(n)){c+="------kissy-editor-2.1\r\n";c+='Content-Disposition: form-data; name="'+n+'"\r\n\r\n';c+=j[n]+"\r\n"}c+="------kissy-editor-2.1--";b.setRequestHeader("Content-Type","multipart/form-data, boundary=----kissy-editor-2.1");
b.sendAsBinary("Content-Type: multipart/form-data; boundary=----kissy-editor-2.1\r\nContent-Length: "+c.length+"\r\n"+c+"\r\n");e.onload=null};e.readAsBinaryString(a)}var d=KISSY,r=d.Editor,w=d.Node,k=d.Event,l=p.cfg.pluginConfig.dragupload||{},v=l.fileInput||"Filedata",x=l.sizeLimit||Number.MAX_VALUE,j=l.serverParams||{},t=l.serverUrl||"",y=RegExp((l.surfix||"png,jpg,jpeg,gif").split(/,/).join("|")+"$","i"),i=p.document,m={},o=false;k.on(i,"dragenter",function(){if(!o){k.on(i,"DOMNodeInserted",q);
o=true}});k.on(i,"dragenter dragover",function(a){a.halt()});k.on(i,"drop",function(a){k.remove(i,"DOMNodeInserted",q);o=false;a.halt();a=a.originalEvent;d.log(a);var g,e;if(d.isEmptyObject(m)){e=i.elementFromPoint(a.clientX,a.clientY);g=e.lastChild}else{d.each(m,function(c){if(d.DOM._4e_name(c)=="img"){g=c.nextSibling;e=c.parentNode;d.DOM._4e_remove(c)}});m={}}a=a.dataTransfer;a.dropEffect="copy";if(a=a.files)for(var f=0;f<a.length;f++){var h=a[f],b=h.size;if(h.name.match(y))if(!(b/1E3>x)){b=new w("<img src='"+
(r.Config.base+"../theme/loading.gif")+"'/>");e.insertBefore(b[0],g);s(h,b)}}});if(window.XMLHttpRequest&&!XMLHttpRequest.prototype.sendAsBinary)XMLHttpRequest.prototype.sendAsBinary=function(a,g){for(var e=new BlobBuilder,f=a.length,h=new Uint8Array(f),b=0;b<f;b++)h[b]=a.charCodeAt(b);e.append(h.buffer);this.send(e.getBlob(g))}},{attach:false});
