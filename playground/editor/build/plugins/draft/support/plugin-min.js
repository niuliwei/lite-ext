KISSY.Editor.add("draft/support",function(){function l(a,b,c){for(a+="";a.length<b;)a=c+a;return a}function n(a){if(g.isNumber(a))a=new Date(a);return a instanceof Date?[a.getFullYear(),"-",l(a.getMonth()+1,2,"0"),"-",l(a.getDate(),2,"0")," ",l(a.getHours(),2,"0"),":",l(a.getMinutes(),2,"0"),":",l(a.getSeconds(),2,"0")].join(""):a}function o(a){this.editor=a;this._init()}var g=KISSY,h=g.Editor,k=g.Node,m=g.Event,p=g.JSON,q=window[h.STORE],i=h.Utils.addRes,u=h.Utils.destroyRes;g.augment(o,{_init:function(){var a=
this,b=a.editor,c=b.statusDiv,d=b.cfg.pluginConfig;d.draft=d.draft||{};a.draftInterval=d.draft.interval=d.draft.interval||5;a.draftLimit=d.draft.limit=d.draft.limit||5;c=(new k("<div class='ke-draft'><spa class='ke-draft-title'>\u5185\u5bb9\u6b63\u6587\u6bcf"+d.draft.interval+"\u5206\u949f\u81ea\u52a8\u4fdd\u5b58\u4e00\u6b21\u3002</span></div>")).appendTo(c);a.timeTip=(new k("<span class='ke-draft-time'>")).appendTo(c);var e=(new k("<a class='ke-button ke-draft-save-btn' style='vertical-align:middle;padding:1px 9px;'><span class='ke-draft-mansave'></span><span>\u7acb\u5373\u4fdd\u5b58</span></a>")).appendTo(c),
f=new h.Select({container:c,menuContainer:document.body,doc:b.document,width:"85px",popUpWidth:"225px",align:["r","t"],title:"\u6062\u590d\u7f16\u8f91\u5386\u53f2"}),j=q.getItem("ke-draft-save"),r=[];a.versions=f;if(j)r=g.isString(j)?p.parse(decodeURIComponent(j)):j;a.drafts=r;a.sync();e.on("click",function(){a.save(false)});i.call(a,e);b.textarea[0].form&&function(){function s(){a.save(false)}var t=b.textarea[0].form;m.on(t,"submit",s);i.call(a,function(){m.remove(t,"submit",s)})}();var v=setInterval(function(){a.save(true)},
a.draftInterval*60*1E3);i.call(a,function(){clearInterval(v)});f.on("click",a.recover,a);i.call(a,f);a.holder=c;if(d.draft.helpHtml){d=new h.TripleButton({cls:"ke-draft-help",title:"\u5e2e\u52a9",text:"\u5e2e\u52a9",container:c});d.on("click",function(){a._prepareHelp()});i.call(a,d);h.Utils.lazyRun(a,"_prepareHelp","_realHelp");a.helpBtn=d.el}a._holder=c;i.call(a,c)},_prepareHelp:function(){function a(){var j=new k(ev.target);j[0]==d[0]||d.contains(j)||b._help.hide()}var b=this,c=b.editor,d=b.helpBtn,e=new k(c.cfg.pluginConfig.draft.helpHtml||
""),f=new k("<div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;border-top-color:#CED5E0;'><div style='height:0;position:absolute;font-size:0;width:0;border:8px #000 solid;border-color:#000 transparent transparent transparent;border-style:solid dashed dashed dashed;left:-8px;top:-10px;border-top-color:white;'></div></div>");e.append(f);e.css({border:"1px solid #ACB4BE","text-align":"left"});
b._help=new g.Overlay({content:e,autoRender:true,width:e.width()+"px",mask:false});b._help.el.css("border","none");b._help.arrow=f;m.on([document,c.document],"click",a);i.call(b,b._help,function(){m.remove([document,c.document],"click",a)})},_realHelp:function(){var a=this._help,b=this.helpBtn,c=a.arrow;a.show();b=b.offset();a.el.offset({left:b.left-a.el.width()+17,top:b.top-a.el.height()-7});c.offset({left:b.left-2,top:b.top-8})},disable:function(){this.holder.css("visibility","hidden")},enable:function(){this.holder.css("visibility",
"")},sync:function(){var a=this.draftLimit,b=this.timeTip,c=this.versions,d=this.drafts;d.length>a&&d.splice(0,d.length-a);a=[];for(var e,f=0;f<d.length;f++){e=d[f];e=(e.auto?"\u81ea\u52a8":"\u624b\u52a8")+"\u4fdd\u5b58\u4e8e : "+n(e.date);a.push({name:e,value:f})}c.set("items",a.reverse());b.html(e);q.setItem("ke-draft-save",encodeURIComponent(p.stringify(d)))},save:function(a){var b=this.drafts,c=this.editor.getData(true);if(c){if(b[b.length-1]&&c==b[b.length-1].content)b.length-=1;this.drafts=b.concat({content:c,date:(new Date).getTime(),
auto:a});this.sync()}},recover:function(a){var b=this.editor,c=this.drafts;a=a.newVal;this.versions.reset("value");if(confirm("\u786e\u8ba4\u6062\u590d "+n(c[a].date)+" \u7684\u7f16\u8f91\u5386\u53f2\uff1f")){b.fire("save");b.setData(c[a].content);b.fire("save")}},destroy:function(){u.call(this)}});h.Draft=o},{requires:["localstorage"]});
